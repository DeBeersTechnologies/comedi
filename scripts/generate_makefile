#!/usr/bin/perl -w


open(IN, "$ARGV[0]");

print "# This Makefile is autogenerated.  Edit Makefile.in instead.\n";
while($_=<IN>){
	if(m/select\(([\w_]+) ([\w_.]+)\)/){
		print "obj-\$($1) += $2\n";
	}elsif(m/expsyms\(([\w_. ]+)\)/){
		print "export-objs += $1\n";
	}elsif(m/objlink\(([\w_.]+) ([\w_. ]+)\)/){
		push @later,"$1: $2\n";
		push @later,"\t\$(LD) -r -o \$@ $2\n";
	}elsif(m/link_subdirs\(([\w_.]+)\)/){
		print "subdir-m += $1\n";
	}elsif(m/^$/){
	}elsif(m/^#/){
	}else{
		print "ack! $_";
	}
}

#print "\n";
#print "M_OBJS  := \$(sort \$(filter-out \$(export-objs), \$(obj-m)))\n";
#print "MX_OBJS := \$(sort \$(filter     \$(export-objs), \$(obj-m)))\n";
#print "SUB_DIRS := \$(subdirs-m)\n";
#print "ALL_SUB_DIRS := \$(SUB_DIRS)\n";
#print "MOD_SUB_DIRS := \$(SUB_DIRS)\n";
print "\n";
print "include \$(TOPDIR)/Rules.make\n";
print "\n";
print @later;

